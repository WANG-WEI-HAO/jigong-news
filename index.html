<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ÊøüÂÖ¨Â†±(ÊØèÊó•7:00Êõ¥Êñ∞)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4EBM386ZCS"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-4EBM386ZCS');
  </script>

  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f9f9f9; transition: background 0.3s, color 0.3s; }
    h1 { color: #5a4fcf; }
    .post { background: white; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .date { font-size: 0.9em; color: #888; }
    .text { margin-top: 0.5em; }
    .text[data-copyable] {
        cursor: pointer;
    }
    .text[data-copyable]:hover {
      background-color: #f0f0f0;
    }
    body.dark-mode .text[data-copyable]:hover {
      background-color: #3a3a3a;
    }

    img { max-width: 100%; margin-top: 1em; border-radius: 6px; cursor: zoom-in; }
    .input-row { display: flex; gap: 1em; margin-bottom: 2em; align-items: center; flex-wrap: wrap; }
    #search, #datePicker {
      padding: 0.5em;
      width: 180px;
      max-width: 100%;
      font-size: 1em;
      margin-bottom: 0;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      transition: border-color 0.2s;
    }
    #search:focus, #datePicker:focus {
      border-color: #5a4fcf;
      outline: none;
    }
    #loadMoreBtn {
      display: none;
      padding: 0.6em 1.2em;
      font-size: 1em;
      background: #5a4fcf;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 1em auto;
    }
    .reset-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.5em;
      color: #5a4fcf;
      padding: 0.2em 0.5em;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .reset-btn:hover { background: #ecebfa; }

    body.dark-mode { background: #1e1e1e; color: #f0f0f0; }
    body.dark-mode .post { background: #2c2c2c; box-shadow: 0 2px 5px rgba(255,255,255,0.05); }
    body.dark-mode .date { color: #bbb; }
    body.dark-mode input, body.dark-mode #search, body.dark-mode #datePicker {
      background: #333; color: white; border-color: #555;
    }
    body.dark-mode #loadMoreBtn { background: #444; }
    body.dark-mode .reset-btn { color: #aaa; }
    body.dark-mode .reset-btn:hover { background: #333; }

    #imageModal {
      display: none;
      position: fixed;
      z-index: 9999;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.85);
      justify-content: center;
      align-items: center;
    }
    #imageModal img {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 10px;
      box-shadow: 0 0 20px black;
      cursor: zoom-out;
    }

    #shareButtonsContainer {
      position: absolute;
      bottom: 25px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(30, 30, 30, 0.85);
      padding: 10px 15px;
      border-radius: 8px;
      display: flex; /* Start with flex for JS to control opacity/visibility */
      gap: 12px;
      z-index: 10000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      opacity: 0; /* Initially hidden via opacity */
      visibility: hidden; /* Initially hidden */
      transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
    }
    #shareButtonsContainer.visible {
        opacity: 1;
        visibility: visible;
    }


    #shareButtonsContainer button,
    #shareButtonsContainer a {
      background-color: #f0f0f0;
      color: #333;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
      font-size: 0.9em;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: background-color 0.2s, transform 0.1s;
    }
    #shareButtonsContainer button:hover,
    #shareButtonsContainer a:hover {
      background-color: #ddd;
    }
    #shareButtonsContainer button:active,
    #shareButtonsContainer a:active {
      transform: scale(0.95);
    }


    #todayBtn {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      z-index: 999;
      padding: 0.8em 1.2em;
      font-size: 1em;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    @media (max-width: 700px) {
      .input-row { flex-direction: column; gap: 0.5em; }
      #search, #datePicker { width: 100%; }
      #shareButtonsContainer {
        bottom: 15px;
        padding: 8px 10px;
        gap: 8px;
      }
      #shareButtonsContainer button,
      #shareButtonsContainer a {
        padding: 6px 10px;
        font-size: 0.8em;
      }
    }
  </style>
</head>
<body>
  <h1>ÊøüÂÖ¨Â†±(ÊØèÊó•7:00Êõ¥Êñ∞)</h1>

  <button id="todayBtn" title="‰ªäÊó•Ë≤ºÊñá">‰ªäÊó•Ë≤ºÊñá</button>
  <button id="themeToggle" style="background: none; border: none; font-size: 1.5em; cursor: pointer; position: fixed; bottom: 1.5rem; left: 1.5rem; z-index: 999;">üåô</button>

  <div class="input-row">
    <input id="search" type="text" placeholder="ÊêúÂ∞ãÂÖßÂÆπ..." />
    <input id="datePicker" type="text" placeholder="ÈÅ∏ÊìáÊó•Êúü..." readonly />
    <button id="resetBtn" class="reset-btn">‚Üª</button>
  </div>

  <div id="content"></div>
  <button id="loadMoreBtn">È°ØÁ§∫Êõ¥Â§ö</button>

  <div id="imageModal">
    <img src="" alt="ÊîæÂ§ßÂúñÁâá" id="modalImage">
    <div id="shareButtonsContainer">
      <!-- Share buttons will be generated here by JS -->
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/zh-tw.js"></script>
 <script>
    let allPosts = [];
    let filteredPosts = [];
    let datePickerInstance = null;
    let renderIndex = 0;
    const batchSize = 10;
    let shareButtonsTimeout = null; // Timeout for hiding share buttons
    const shareButtonHideDelay = 2000; // 2 seconds

    function getImageUrl(imagePath) {
      if (!imagePath) return "";
      if (/^https?:\/\//.test(imagePath)) {
        return imagePath;
      }
      return imagePath.replace(/\\/g, '/');
    }

    function showCopyFeedback(element, message, isError = false, originalHTML) {
        const originalTitle = element.getAttribute('title');
        const originalCursor = element.style.cursor;
        const originalDataCopyable = element.hasAttribute('data-copyable');

        element.textContent = message;
        element.style.color = isError ? 'red' : (document.body.classList.contains('dark-mode') ? '#a5d6a7' : '#2e7d32');
        element.style.fontWeight = 'bold';
        element.style.cursor = 'default';
        if(originalDataCopyable) element.removeAttribute('data-copyable');
        element.removeAttribute('title');

        setTimeout(() => {
            element.innerHTML = originalHTML;
            element.style.color = '';
            element.style.fontWeight = '';
            element.style.cursor = originalCursor;
            if(originalDataCopyable) element.setAttribute('data-copyable', '');
            if(originalTitle) element.setAttribute('title', originalTitle);
        }, 1500);
    }

    async function copyTextToClipboard(textToCopy, elementForFeedback, originalDisplayHTML) {
        if (!textToCopy) return;

        if (!navigator.clipboard) {
            try {
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.position = "fixed"; 
                textArea.style.opacity = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showCopyFeedback(elementForFeedback, "Â∑≤Ë§áË£ΩÔºÅ", false, originalDisplayHTML);
            } catch (err) {
                console.error('Fallback: ÁÑ°Ê≥ïË§áË£ΩÊñáÂ≠ó', err);
                showCopyFeedback(elementForFeedback, "Ë§áË£ΩÂ§±Êïó", true, originalDisplayHTML);
            }
            return;
        }

        try {
            await navigator.clipboard.writeText(textToCopy);
            showCopyFeedback(elementForFeedback, "Â∑≤Ë§áË£ΩÔºÅ", false, originalDisplayHTML);
        } catch (err) {
            console.error('Async: ÁÑ°Ê≥ïË§áË£ΩÊñáÂ≠ó: ', err);
            showCopyFeedback(elementForFeedback, "Ë§áË£ΩÂ§±Êïó", true, originalDisplayHTML);
        }
    }

    function renderBatch() {
      const container = document.getElementById("content");
      const postsToRender = filteredPosts.slice(renderIndex, renderIndex + batchSize);

      postsToRender.forEach(post => {
        const div = document.createElement("div");
        div.className = "post";
        const imgTag = post.image ? `<img src="${getImageUrl(post.image)}" alt="ÂúñÁâá" onerror="this.style.display='none';">` : "";
        
        const originalTextForCopy = post.text || ""; 
        const displayTextForRender = originalTextForCopy.replace(/\n/g, "<br>");

        div.innerHTML = `
          <div class="date">${post.date || ""}</div>
          <div class="text"></div>
          ${imgTag}
        `;
        
        const textElement = div.querySelector('.text');
        if (textElement) {
            textElement.innerHTML = displayTextForRender;

            if (originalTextForCopy.trim() !== "") {
                textElement.setAttribute('data-copyable', '');
                textElement.setAttribute('title', 'ÈªûÊìäË§áË£ΩÂÖßÊñá');

                textElement.addEventListener('click', (event) => {
                    if (event.target.tagName === 'IMG') { 
                        return; 
                    }
                    copyTextToClipboard(originalTextForCopy, textElement, displayTextForRender); 
                });
            }
        }
        container.appendChild(div);
      });

      renderIndex += postsToRender.length;
      document.getElementById("loadMoreBtn").style.display = renderIndex >= filteredPosts.length ? "none" : "block";
    }

    function render(posts) {
      document.getElementById("content").innerHTML = "";
      renderIndex = 0;
      renderBatch();
    }
    
    function getAllDates(posts) {
      return [...new Set(posts.map(post => post.date).filter(Boolean))].sort((a, b) => b.localeCompare(a));
    }

    function fetchAndRender() {
      fetch("posts.json")
        .then(res => {
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          allPosts = data.sort((a, b) => (b.date || "").localeCompare(a.date || ""));
          filteredPosts = allPosts;
          render(filteredPosts);

          if (datePickerInstance) {
            datePickerInstance.destroy();
          }
          datePickerInstance = flatpickr("#datePicker", {
            dateFormat: "Y-m-d",
            disableMobile: true,
            locale: "zh_tw",
            onChange: function(selectedDates, dateStr, instance) {
              filterAndRender();
            },
            enable: getAllDates(allPosts)
          });
        })
        .catch(error => {
          console.error("Error fetching or processing posts:", error);
          document.getElementById("content").innerHTML = "<p>ÁÑ°Ê≥ïËºâÂÖ•ÊñáÁ´†ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ</p>";
        });
    }

    function filterAndRender() {
      const keywordInput = document.getElementById("search").value.trim().toLowerCase();
      const keywords = keywordInput.split(/\s+/).filter(Boolean);
      const date = document.getElementById("datePicker").value.trim();

      filteredPosts = allPosts.filter(post => {
        const postText = (post.text || "").toLowerCase();
        const postDate = (post.date || "");
        
        const matchText = keywords.length === 0 || keywords.every(kw => postText.includes(kw));
        const matchDate = !date || postDate === date;

        return matchText && matchDate;
      });
      render(filteredPosts);
    }

    document.getElementById("search").addEventListener("input", filterAndRender);
    document.getElementById("loadMoreBtn").addEventListener("click", renderBatch);
    document.getElementById("resetBtn").addEventListener("click", function() {
      document.getElementById("search").value = "";
      document.getElementById("datePicker").value = "";
      if (datePickerInstance) {
        datePickerInstance.clear();
      }
      filterAndRender();
    });

    document.getElementById("todayBtn").addEventListener("click", () => {
      const today = new Date();
      const offset = today.getTimezoneOffset() * 60000;
      const localISO = new Date(today - offset).toISOString().slice(0, 10);
      
      document.getElementById("datePicker").value = localISO;
      if (datePickerInstance) {
        datePickerInstance.setDate(localISO, true);
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    const themeToggle = document.getElementById("themeToggle");
    const storedTheme = localStorage.getItem("theme");
    if (storedTheme === "dark") {
      document.body.classList.add("dark-mode");
      themeToggle.textContent = "‚òÄ";
    } else {
      themeToggle.textContent = "üåô";
    }
    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      const isDark = document.body.classList.contains("dark-mode");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      themeToggle.textContent = isDark ? "‚òÄ" : "üåô";
    });

    let imageList = [];
    let currentImageIndex = -1;

    function updateImageList() {
        imageList = Array.from(document.querySelectorAll(".post img")).map(img => img.src);
    }

    function showShareButtons() {
        const container = document.getElementById('shareButtonsContainer');
        if (container) {
            container.classList.add('visible');
            clearTimeout(shareButtonsTimeout); // Clear any existing timeout
            shareButtonsTimeout = setTimeout(hideShareButtons, shareButtonHideDelay);
        }
    }

    function hideShareButtons() {
        const container = document.getElementById('shareButtonsContainer');
        if (container) {
            container.classList.remove('visible');
        }
    }

    function generateShareButtons(imageUrl, postText = "") {
        const container = document.getElementById('shareButtonsContainer');
        if (!container) return;
        container.innerHTML = ''; 

        const encodedImageUrl = encodeURIComponent(imageUrl);
        const shareTextContent = postText ? postText.substring(0, 100) + (postText.length > 100 ? "..." : "") : document.title;
        // const encodedShareText = encodeURIComponent(shareTextContent); // Not directly used for IG

        const shares = [
            { name: 'Facebook', url: `https://www.facebook.com/sharer/sharer.php?u=${encodedImageUrl}`, icon: 'üìò' },
            { 
                name: 'Instagram', 
                // Instagram does not have a direct web share API for pre-filling images.
                // This link will open Instagram. Users need to manually post.
                // Could also try instagram://app but that's mobile specific and might not work universally.
                url: `https://www.instagram.com/`, 
                icon: 'üì∏',
                title: 'Âú® Instagram ÊâìÈñã (ÈúÄÊâãÂãï‰∏äÂÇ≥ÂúñÁâá)'
            },
            { name: 'Line', url: `https://social-plugins.line.me/lineit/share?url=${encodedImageUrl}&text=${encodeURIComponent(shareTextContent)}`, icon: 'üì±' },
            {
                name: 'Ë§áË£ΩÈÄ£Áµê',
                action: (event) => {
                    event.stopPropagation(); 
                    showShareButtons(); // Keep buttons visible if one is interacted with
                    navigator.clipboard.writeText(imageUrl).then(() => {
                        const btn = event.currentTarget;
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '‚úÖ Â∑≤Ë§áË£Ω';
                        setTimeout(() => { btn.innerHTML = originalText; }, 1500);
                    }).catch(err => {
                        console.error('ÁÑ°Ê≥ïË§áË£ΩÈÄ£Áµê: ', err);
                        alert('Ë§áË£ΩÈÄ£ÁµêÂ§±Êïó„ÄÇ');
                    });
                },
                icon: 'üîó'
            }
        ];

        shares.forEach(share => {
            const element = share.url ? document.createElement('a') : document.createElement('button');
            element.innerHTML = `${share.icon} ${share.name}`;
            element.title = share.title || `ÂàÜ‰∫´Âà∞ ${share.name}`; // Use custom title if provided
            if (share.className) element.classList.add(share.className);

            if (share.url) {
                element.href = share.url;
                element.target = '_blank';
                element.rel = 'noopener noreferrer';
                element.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showShareButtons(); // Keep buttons visible if one is interacted with
                }); 
            } else if (share.action) {
                element.addEventListener('click', share.action); // Action should handle stopPropagation and showShareButtons if needed
            }
            container.appendChild(element);
        });
        showShareButtons(); // Initially show buttons and start timer
    }
    
    function showModal(clickedImgSrc) {
        updateImageList();
        const index = imageList.indexOf(clickedImgSrc);
        if (index === -1) return;

        currentImageIndex = index;
        const modal = document.getElementById("imageModal");
        const modalImg = document.getElementById("modalImage");
        modalImg.src = imageList[currentImageIndex]; 
        
        modal.style.display = "flex";
        document.body.style.overflow = 'hidden';

        let postTextForShare = "";
        const originalPost = filteredPosts.find(p => getImageUrl(p.image) === modalImg.src);
        if (originalPost && originalPost.text) {
            postTextForShare = originalPost.text;
        } else {
            const imgElement = document.querySelector(`.post img[src="${clickedImgSrc}"]`);
            if (imgElement) {
                const postElement = imgElement.closest('.post');
                if (postElement) {
                    const textDiv = postElement.querySelector('.text');
                    if (textDiv) postTextForShare = textDiv.innerText;
                }
            }
        }
        generateShareButtons(modalImg.src, postTextForShare);
    }

    function hideModal() {
        const modal = document.getElementById("imageModal");
        modal.style.display = "none";
        document.body.style.overflow = 'auto';
        currentImageIndex = -1;
        clearTimeout(shareButtonsTimeout); // Clear timeout when modal closes
        hideShareButtons(); // Ensure buttons are hidden
    }
    
    function navigateModalImage(direction) {
        if (currentImageIndex === -1 || imageList.length === 0) return;
        
        currentImageIndex += direction;
        
        if (currentImageIndex < 0) {
            currentImageIndex = imageList.length - 1; 
        } else if (currentImageIndex >= imageList.length) {
            currentImageIndex = 0; 
        }
        const newImgSrc = imageList[currentImageIndex];
        document.getElementById("modalImage").src = newImgSrc;
        
        let postTextForShare = "";
        const originalPost = filteredPosts.find(p => getImageUrl(p.image) === newImgSrc);
        if (originalPost && originalPost.text) {
            postTextForShare = originalPost.text;
        }
        generateShareButtons(newImgSrc, postTextForShare); // This will also call showShareButtons
    }

    document.getElementById("content").addEventListener("click", function (e) {
      if (e.target.tagName === "IMG" && e.target.closest(".post")) {
        if (!e.target.closest('.text[data-copyable]')) {
             showModal(e.target.src);
        }
      }
    });
    
    const imageModal = document.getElementById('imageModal');
    const modalImageElement = document.getElementById('modalImage');

    if (imageModal) {
        imageModal.addEventListener('click', (event) => {
            if (event.target === imageModal || event.target === modalImageElement) {
                hideModal();
            } else if (event.target !== document.getElementById('shareButtonsContainer') && !event.target.closest('#shareButtonsContainer')) {
                // If click is on modal background (not image or share buttons), show share buttons
                showShareButtons();
            }
        });
        imageModal.addEventListener('mousemove', () => {
             // For desktop: show buttons on mouse move within modal
            if(document.getElementById("imageModal").style.display === "flex") {
                showShareButtons();
            }
        });
    }

    document.addEventListener("keydown", function (e) {
      const modalVisible = document.getElementById("imageModal").style.display === "flex";
      if (!modalVisible) return;

      if (e.key === "Escape") {
        hideModal();
      } else if (e.key === "ArrowRight") {
        navigateModalImage(1);
      } else if (e.key === "ArrowLeft") {
        navigateModalImage(-1);
      }
    });

    fetchAndRender();
  </script>
</body>
</html>
