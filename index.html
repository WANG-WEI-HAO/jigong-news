<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>æ¿Ÿå…¬å ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#5a4fcf"/>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- Apple PWA tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="æ¿Ÿå…¬å ±">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4EBM386ZCS"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-4EBM386ZCS');
  </script>

  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f9f9f9; transition: background 0.3s, color 0.3s; -webkit-tap-highlight-color: transparent; }
    h1 { color: #5a4fcf; display: flex; align-items: baseline; flex-wrap: wrap; }
    h1 .subtitle {
      font-size: 0.6em; /* èª¿æ•´ç‚º h1 çš„ 60% å¤§å° */
      font-weight: normal; /* æ­£å¸¸å­—é‡ */
      color: #666; /* è¼ƒæ·ºçš„é¡è‰² */
      margin-left: 0.5em; /* èˆ‡ä¸»æ¨™é¡Œçš„é–“è· */
    }
    .footer {
            text-align: center;
            padding: 5px;
            margin-top: 5px;
            border-top: 1px solid #e9ecef;
            color: #6c757d;
        }
    .post { background: white; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .date { font-size: 0.9em; color: #888; }    .text { margin-top: 0.5em; }
    /* .text[data-copyable] { cursor: pointer; } /* ç§»é™¤é»æ“Šè¤‡è£½åŠŸèƒ½å¾Œï¼Œä¸å†éœ€è¦ pointer cursor */
    .text[data-copyable]:hover { background-color: #f0f0f0; }
    body.dark-mode .text[data-copyable]:hover { background-color: #3a3a3a; }

    img { max-width: 100%; margin-top: 1em; border-radius: 6px; cursor: zoom-in; }
    .input-row { display: flex; gap: 1em; margin-bottom: 2em; align-items: center; flex-wrap: wrap; }
    #search, #datePicker {
      padding: 0.5em; width: 180px; max-width: 100%; font-size: 1em; margin-bottom: 0;
      box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; transition: border-color 0.2s;
    }
    #search:focus, #datePicker:focus { border-color: #5a4fcf; outline: none; }
    #loadMoreBtn {
      display: none; padding: 0.6em 1.2em; font-size: 1em; background: #5a4fcf; color: white;
      border: none; border-radius: 5px; cursor: pointer; margin: 1em auto;
    }
    .reset-btn {
      background: none; border: none; cursor: pointer; font-size: 1.5em; color: #5a4fcf;
      padding: 0.2em 0.5em; border-radius: 4px; transition: background 0.2s;
    }
    .reset-btn:hover { background: #ecebfa; }

    body.dark-mode { background: #1e1e1e; color: #f0f0f0; }
    body.dark-mode .post { background: #2c2c2c; box-shadow: 0 2px 5px rgba(255,255,255,0.05); }
    body.dark-mode .date { color: #bbb; }
    body.dark-mode h1 .subtitle { color: #bbb; }
    body.dark-mode input, body.dark-mode #search, body.dark-mode #datePicker {
      background: #333; color: white; border-color: #555;
    }
    body.dark-mode #loadMoreBtn { background: #444; }
    body.dark-mode .reset-btn { color: #aaa; }
    body.dark-mode .reset-btn:hover { background: #333; }

    #imageModal {
      display: none; position: fixed; z-index: 9999; top: 0; left: 0;
      width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.85);
      justify-content: center; align-items: center; overflow: hidden;
    }
    #imageModal img {
      max-width: 90vw; max-height: 90vh; border-radius: 10px;
      box-shadow: 0 0 20px black;
      user-select: none; -webkit-user-drag: none;
    }

    #modalCloseBtn {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 2em;
        color: white;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.2em 0.5em;
        line-height: 1;
        text-shadow: 0 0 5px black;
        z-index: 10001; 
    }
     #modalCloseBtn:hover {
        color: #ccc;
    }

    .modal-nav-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 3em;
        font-weight: bold;
        color: white;
        background-color: rgba(0, 0, 0, 0.3);
        border: none;
        cursor: pointer;
        padding: 0.3em 0.6em;
        line-height: 1;
        text-shadow: 0 0 5px black;
        z-index: 10001;
        border-radius: 8px;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
    }
    .modal-nav-btn:hover { background-color: rgba(0, 0, 0, 0.6); }
    #modalPrevBtn { left: 40px; }
    #modalNextBtn { right: 40px; }

    .modal-nav-btn.visible {
        opacity: 1;
        visibility: visible;
    }
    #shareButtonsContainer {
      position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
      background-color: rgba(30, 30, 30, 0.85); padding: 10px 15px; border-radius: 8px;
      display: flex; gap: 12px; z-index: 10000; box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
    }
    #shareButtonsContainer.visible { opacity: 1; visibility: visible; }

    #shareButtonsContainer button, #shareButtonsContainer a {
      background-color: transparent; color: #f0f0f0; border: none;
      border-radius: 5px; cursor: pointer; text-decoration: none;
      display: inline-flex; align-items: center; transition: background-color 0.2s, transform 0.1s;
      padding: 6px 10px;
    }
    #shareButtonsContainer button:hover, #shareButtonsContainer a:hover { background-color: #ddd; }
    #shareButtonsContainer button:active, #shareButtonsContainer a:active { transform: scale(0.95); }

    #shareButtonsContainer button:hover img.share-btn-icon, 
    #shareButtonsContainer a:hover img.share-btn-icon { }
    #shareButtonsContainer .share-btn-icon {
      width: 25px;
      height: 25px;
      cursor: pointer;
      border-radius: 4px;
      overflow: hidden;
    }

    #todayBtn {
      position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 999; padding: 0.8em 1.2em;
      font-size: 1em; background: #28a745; color: white; border: none;
      border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* #notificationsBtn å·²è¢« #subscribe-btn å–ä»£ï¼Œæ‰€ä»¥å¯ä»¥ç§»é™¤å…¶ CSS */
    /* ç§»é™¤æ‰ #notificationsBtn çš„æ ·å¼ï¼Œå› ä¸ºå®ƒä¸å†å­˜åœ¨ */


    #themeToggle {
      background: none; 
      border: none; 
      font-size: 1.5em; 
      cursor: pointer; 
      position: fixed; 
      bottom: 1.5rem; 
      left: 1.5rem; 
      z-index: 999;
    }
    #subscribe-btn {
      position: fixed;
      bottom: 1.5rem;
      right: 9rem;
      z-index: 999;
      padding: 0.8em 1.2em;
      font-size: 1em;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    @media (max-width: 700px) {
      .input-row { flex-direction: column; gap: 0.5em; }
    #search, #datePicker { width: 100%; }
      #modalCloseBtn { top: 15px; font-size: 1.8em; }
      .modal-nav-btn { font-size: 1.8em; }
      #modalPrevBtn { left: 35px; } 
      #modalNextBtn { right: 35px; }
      #shareButtonsContainer {
        bottom: 15px; padding: 8px 10px; gap: 8px;
      }
      #shareButtonsContainer button, #shareButtonsContainer a {
        padding: 4px 8px;
      }
    }

    /* PWA å®‰è£…æç¤ºå¼¹çª—æ ·å¼ */
    #installAppPrompt {
        display: none; /* é»˜è®¤éšè— */
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        font-size: 1.1em;
        text-align: center;
        max-width: 90%;
        box-sizing: border-box;
    }
    #installAppPrompt button {
        background-color: #5a4fcf;
        color: white;
        border: none;
        padding: 8px 15px;
        margin-left: 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        transition: background-color 0.2s;
    }
    #installAppPrompt button:hover {
        background-color: #4a3eaf;
    }
    #installAppPrompt .close-btn {
        background-color: transparent;
        color: #bbb;
        font-size: 1.2em;
        position: absolute;
        top: 5px;
        right: 10px;
        padding: 0 5px;
        line-height: 1;
    }
    #installAppPrompt .close-btn:hover {
        color: white;
    }

    /* Dark Mode for Prompt */
    body.dark-mode #installAppPrompt {
        background-color: #2c2c2c;
        box-shadow: 0 4px 10px rgba(255, 255, 255, 0.1);
    }
    body.dark-mode #installAppPrompt button {
        background-color: #5a4fcf;
    }
    body.dark-mode #installAppPrompt button:hover {
        background-color: #4a3eaf;
    }
  </style>

</head>
<body>
  <h1>æ¿Ÿå…¬å ±<span class="subtitle">ï¼ˆæ¯æ—¥7:00æ›´æ–°ï¼‰</span></h1>
  <button id="todayBtn" title="ä»Šæ—¥è²¼æ–‡">ä»Šæ—¥è²¼æ–‡</button>
  <button id="subscribe-btn" title="å•Ÿç”¨æ›´æ–°é€šçŸ¥">ğŸ”” é–‹å•Ÿé€šçŸ¥</button>
  <button id="themeToggle">ğŸŒ™</button>
  
  <div class="input-row">
    <input id="search" type="text" placeholder="æœå°‹å…§å®¹..." />
    <input id="datePicker" type="text" placeholder="é¸æ“‡æ—¥æœŸ..." readonly />
    <button id="resetBtn" class="reset-btn">â†»</button>
  </div>

  <div id="content"></div>
  <button id="loadMoreBtn">é¡¯ç¤ºæ›´å¤š</button>

   <!-- PWA å®‰è£…æç¤ºå¼¹çª— -->
  <div id="installAppModal">
    <div class="install-modal-content">
      <h2>å®‰è£æ¿Ÿå…¬å ± App</h2>
      <p>å®‰è£APPç²å¾—æœ€ä½³é«”é©—</p>
      <button id="installAppBtn">å®‰è£</button>
      <button id="cancelInstallBtn">å–æ¶ˆ</button>
    </div>
  </div>
  
  <div id="imageModal">
    <button id="modalCloseBtn" title="é—œé–‰">Ã—</button>
    <button id="modalPrevBtn" class="modal-nav-btn" title="ä¸Šä¸€å¼µ"><</button>
    <img alt="æ”¾å¤§åœ–ç‰‡" id="modalImage">
    <button id="modalNextBtn" class="modal-nav-btn" title="ä¸‹ä¸€å¼µ">></button>
    <div id="shareButtonsContainer">
      <!-- Share buttons will be generated here by JS -->
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="./zh-tw.js"></script>

  <!-- ä½ çš„ä¸»è¦åº”ç”¨é€»è¾‘ (ç°æœ‰ä»£ç ) -->
  <script>
    // å°†æ‰€æœ‰ä¸»åº”ç”¨é€»è¾‘ä»£ç åŒ…è£¹åœ¨ DOMContentLoaded äº‹ä»¶ä¸­
    document.addEventListener('DOMContentLoaded', (event) => {
        let allPosts = [];
        let filteredPosts = [];
        let datePickerInstance = null;
        let renderIndex = 0;
        const batchSize = 10;
        let shareButtonsTimeout = null;
        const shareButtonHideDelay = 3000;
        let modalNavButtonsTimeout = null;
        const modalNavButtonHideDelay = 2000;
        let touchStartX = 0;
        let touchEndX = 0;
        const swipeThreshold = 50;

        function getImageUrl(imagePath) {
          if (!imagePath) return "";
          if (/^https?:\/\//.test(imagePath)) return imagePath;
          return imagePath.replace(/\\/g, '/');
        }

        function showCopyFeedback(element, message, isError = false, originalHTML) {
            const originalTitle = element.getAttribute('title'); const originalCursor = element.style.cursor;
            const originalDataCopyable = element.hasAttribute('data-copyable');
            element.textContent = message;
            element.style.color = isError ? 'red' : (document.body.classList.contains('dark-mode') ? '#a5d6a7' : '#2e7d32');
            element.style.fontWeight = 'bold'; element.style.cursor = 'default';
            if(originalDataCopyable) element.removeAttribute('data-copyable'); element.removeAttribute('title');
            setTimeout(() => {
                element.innerHTML = originalHTML; element.style.color = ''; element.style.fontWeight = '';
                element.style.cursor = originalCursor;
                if(originalDataCopyable) element.setAttribute('data-copyable', '');
                if(originalTitle) element.setAttribute('title', originalTitle);
            }, 1500);
        }

        async function copyTextToClipboard(textToCopy, elementForFeedback, originalDisplayHTML) {
            if (!textToCopy) return;
            if (!navigator.clipboard) {
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = textToCopy;
                    textArea.style.position = "fixed";
                    textArea.style.opacity = "0";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showCopyFeedback(elementForFeedback, "å·²è¤‡è£½ï¼", false, originalDisplayHTML);
                } catch (err) {
                    showCopyFeedback(elementForFeedback, "è¤‡è£½å¤±æ•—", true, originalDisplayHTML);
                }
                return;
            }
            try {
                await navigator.clipboard.writeText(textToCopy);
                showCopyFeedback(elementForFeedback, "å·²è¤‡è£½ï¼", false, originalDisplayHTML);
            } catch (err) {
                showCopyFeedback(elementForFeedback, "è¤‡è£½å¤±æ•—", true, originalDisplayHTML);
            }
        }

        function renderBatch() {
          const container = document.getElementById("content");
          const postsToRender = filteredPosts.slice(renderIndex, renderIndex + batchSize);
          postsToRender.forEach(post => {
            const div = document.createElement("div"); div.className = "post";
            const imgTag = post.image ? `<img src="${getImageUrl(post.image)}" alt="åœ–ç‰‡" onerror="this.style.display='none';">` : "";
            const displayTextForRender = (post.text || "").replace(/\n/g, "<br>");
            
            div.innerHTML = `<div class="date">${post.date || ""}</div><div class="text"></div>${imgTag}`;
            const textElement = div.querySelector('.text');

            if (textElement) {
                textElement.innerHTML = displayTextForRender;

                if (displayTextForRender.trim() !== "") {
                    textElement.setAttribute('data-copyable', '');
                    textElement.addEventListener('click', (event) => {
                        if (event.target.tagName === 'IMG') return;
                    });
                }
            }
            container.appendChild(div);
          });
          renderIndex += postsToRender.length;
          document.getElementById("loadMoreBtn").style.display = renderIndex >= filteredPosts.length ? "none" : "block";
        }

        function render(posts) { document.getElementById("content").innerHTML = ""; renderIndex = 0; renderBatch(); }
        function getAllDates(posts) { return [...new Set(posts.map(post => post.date).filter(Boolean))].sort((a, b) => b.localeCompare(a.date || "")); }

        function fetchAndRender() {
          fetch("posts.json")
            .then(res => { if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`); return res.json(); })
            .then(data => {
              allPosts = data.sort((a, b) => (b.date || "").localeCompare(a.date || ""));
              filteredPosts = allPosts; render(filteredPosts);
              if (datePickerInstance) datePickerInstance.destroy();
              datePickerInstance = flatpickr("#datePicker", {
                dateFormat: "Y-m-d", disableMobile: true, locale: "zh_tw",
                onChange: function() { filterAndRender(); }, enable: getAllDates(allPosts)
              });
            })
            .catch(error => { console.error("Error fetching or processing posts:", error); document.getElementById("content").innerHTML = "<p>ç„¡æ³•è¼‰å…¥æ–‡ç« ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>"; });
        }

        function filterAndRender() {
          const keywordInput = document.getElementById("search").value.trim().toLowerCase();
          const keywords = keywordInput.split(/\s+/).filter(Boolean); const date = document.getElementById("datePicker").value.trim();
          filteredPosts = allPosts.filter(post => {
            const postText = (post.text || "").toLowerCase(); const postDate = (post.date || "");
            const matchText = keywords.length === 0 || keywords.every(kw => postText.includes(kw));
            const matchDate = !date || postDate === date; return matchText && matchDate;
          });
          render(filteredPosts);
        }

        document.getElementById("search").addEventListener("input", filterAndRender);
        document.getElementById("loadMoreBtn").addEventListener("click", renderBatch);
        document.getElementById("resetBtn").addEventListener("click", function() {
          document.getElementById("search").value = ""; document.getElementById("datePicker").value = "";
          if (datePickerInstance) datePickerInstance.clear(); filterAndRender();
        });
        document.getElementById("todayBtn").addEventListener("click", () => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        const themeToggle = document.getElementById("themeToggle");
        const storedTheme = localStorage.getItem("theme");
        if (storedTheme === "dark") { document.body.classList.add("dark-mode"); themeToggle.textContent = "ğŸ”†"; } 
        else { themeToggle.textContent = "ğŸŒ™"; }
        themeToggle.addEventListener("click", () => {
          document.body.classList.toggle("dark-mode"); const isDark = document.body.classList.contains("dark-mode");
          localStorage.setItem("theme", isDark ? "dark" : "light"); themeToggle.textContent = isDark ? "ğŸ”†" : "ğŸŒ™";
        });

        let imageList = []; let currentImageIndex = -1;
        function updateImageList() { imageList = Array.from(document.querySelectorAll(".post img")).map(img => img.src); }

        function showShareButtons() {
            const container = document.getElementById('shareButtonsContainer');
            if (container) { container.classList.add('visible'); clearTimeout(shareButtonsTimeout);
                shareButtonsTimeout = setTimeout(hideShareButtons, shareButtonHideDelay);
            }
        }
        function hideShareButtons() { const container = document.getElementById('shareButtonsContainer'); if (container) container.classList.remove('visible'); }

        function showModalNavButtons() {
            const prevBtn = document.getElementById('modalPrevBtn');
            const nextBtn = document.getElementById('modalNextBtn');
            if (prevBtn && nextBtn && imageModal.style.display === "flex") {
                prevBtn.classList.add('visible');
                nextBtn.classList.add('visible');
                clearTimeout(modalNavButtonsTimeout);
                modalNavButtonsTimeout = setTimeout(hideModalNavButtons, modalNavButtonHideDelay);
            }
        }

        function hideModalNavButtons() {
            const prevBtn = document.getElementById('modalPrevBtn');
            const nextBtn = document.getElementById('modalNextBtn');
            if (prevBtn && nextBtn) {
                prevBtn.classList.remove('visible');
                nextBtn.classList.remove('visible');
            }
        }

        function generateShareButtons(imageUrl, postText = "") {
            const container = document.getElementById('shareButtonsContainer'); if (!container) return; container.innerHTML = ''; 
            const siteToShareUrl = "https://sites.google.com/view/fycd-tc/%E6%BF%9F%E5%85%AC%E5%A0%B1";
            const encodedSiteToShareUrl = encodeURIComponent(siteToShareUrl);

            const shareTextContent = postText ? postText.substring(0, 100) + (postText.length > 100 ? "..." : "") : document.title;
            const lineShareText = encodeURIComponent(`${shareTextContent}\n${siteToShareUrl}`);
            const shares = [
                {
                    name: 'Facebook',
                    action: (event) => {
                        event.stopPropagation();
                        showShareButtons();
                        const fbShareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodedSiteToShareUrl}`;
                        window.open(fbShareUrl, '_blank', 'noopener,noreferrer');
                    },
                    icon: 'ICON/facebook.png'
                },
                {
                    name: 'Instagram',
                    action: (event) => {
                        event.stopPropagation();
                        showShareButtons();
                        window.open(`https://www.instagram.com/`, '_blank', 'noopener,noreferrer');
                    },
                    icon: 'ICON/instagram.png', title: 'åœ¨ Instagram æ‰“é–‹ (éœ€æ‰‹å‹•ä¸Šå‚³åœ–ç‰‡)'
                },
                { 
                    name: 'Line', 
                    action: (event) => { event.stopPropagation(); showShareButtons(); window.open(`line://msg/text/?${lineShareText}`, '_blank'); }, 
                    icon: 'ICON/line.png'
                },
                { 
                    name: 'è¤‡è£½ç¶²ç«™åŠåœ–ç‰‡é€£çµ', 
                    action: (event) => { 
                        event.stopPropagation(); 
                        showShareButtons();
                        const currentClickedButton = event.currentTarget;
                        const textToCopy = `ç¶²ç«™é€£çµï¼š${siteToShareUrl}\nåœ–ç‰‡é€£çµï¼š${imageUrl}`;
                        console.log("Attempting to copy site and image links (share button):", textToCopy);

                        navigator.clipboard.writeText(textToCopy).then(() => { 
                            console.log("Site and image links copied successfully (share button)!"); 
                            if (currentClickedButton) {
                                const originalIconHTML = currentClickedButton.innerHTML; 
                                currentClickedButton.innerHTML = 'âœ… å·²è¤‡è£½'; 
                                setTimeout(() => { 
                                    if (currentClickedButton.parentNode === document.getElementById('shareButtonsContainer')) {
                                        currentClickedButton.innerHTML = originalIconHTML; 
                                    }
                                }, 1500); 
                            }
                        }).catch(err => { 
                            console.error('ç„¡æ³•è¤‡è£½é€£çµ (share button): ', err); 
                            alert('è¤‡è£½é€£çµå¤±æ•—ã€‚'); 
                        }); 
                    }, 
                    icon: 'ICON/link.png', title: 'è¤‡è£½ç¶²ç«™åŠåœ–ç‰‡é€£çµ'
                }
            ];
            shares.forEach(share => {
                const element = share.url && !share.action ? document.createElement('a') : document.createElement('button');
                element.innerHTML = `<img src="${share.icon}" alt="${share.name}" class="share-btn-icon">`; element.title = share.title || `åˆ†äº«åˆ° ${share.name}`;
                if (share.className) element.classList.add(share.className);
                if (share.url && !share.action) {
                    element.href = share.url; element.target = '_blank'; element.rel = 'noopener noreferrer';
                    element.addEventListener('click', (e) => { e.stopPropagation(); showShareButtons(); }); 
                } else if (share.action) { element.addEventListener('click', share.action); }
                container.appendChild(element);
            });
            showShareButtons();
        }
        
        function showModal(clickedImgSrc) {
            updateImageList(); const index = imageList.indexOf(clickedImgSrc); if (index === -1) return;
            currentImageIndex = index;
            const modal = document.getElementById("imageModal"); const modalImg = document.getElementById("modalImage");
            modalImg.src = imageList[currentImageIndex]; 
            modal.style.display = "flex"; document.body.style.overflow = 'hidden';
            let postTextForShare = "";
            const originalPost = filteredPosts.find(p => getImageUrl(p.image) === modalImg.src);
            if (originalPost && originalPost.text) postTextForShare = originalPost.text;
            else {
                const imgElement = document.querySelector(`.post img[src="${clickedImgSrc}"]`);
                if (imgElement) { const postElement = imgElement.closest('.post');
                    if (postElement) { const textDiv = postElement.querySelector('.text'); if (textDiv) postTextForShare = textDiv.innerText; }
                }
            }
            generateShareButtons(modalImg.src, postTextForShare);
            showModalNavButtons();
        }

        function hideModal() {
            const modal = document.getElementById("imageModal"); modal.style.display = "none";
            document.body.style.overflow = 'auto'; currentImageIndex = -1;
            clearTimeout(shareButtonsTimeout); hideShareButtons();
            clearTimeout(modalNavButtonsTimeout); hideModalNavButtons();
        }
        
        function navigateModalImage(direction) {
            if (currentImageIndex === -1 || imageList.length === 0) return;
            currentImageIndex += direction;
            if (currentImageIndex < 0) currentImageIndex = imageList.length - 1; 
            else if (currentImageIndex >= imageList.length) currentImageIndex = 0; 
            const newImgSrc = imageList[currentImageIndex];
            document.getElementById("modalImage").src = newImgSrc;
            let postTextForShare = "";
            const originalPost = filteredPosts.find(p => getImageUrl(p.image) === newImgSrc);
            if (originalPost && originalPost.text) postTextForShare = originalPost.text;
            generateShareButtons(newImgSrc, postTextForShare);
            showModalNavButtons();
        }

        document.getElementById("content").addEventListener("click", function (e) {
          if (e.target.tagName === "IMG" && e.target.closest(".post")) {
            if (!e.target.closest('.text[data-copyable]')) showModal(e.target.src);
          }
        });
        
        const imageModal = document.getElementById('imageModal');
        const modalCloseButton = document.getElementById('modalCloseBtn'); 

        if (imageModal) {
            imageModal.addEventListener('click', (event) => {
                if (event.target === imageModal) {
                     hideModal();
                } else if (event.target !== document.getElementById('modalImage') && 
                           event.target !== modalCloseButton && 
                           !event.target.closest('#shareButtonsContainer') &&
                           event.target !== document.getElementById('shareButtonsContainer')) {
                    showShareButtons();
                    showModalNavButtons();
                }
            });
            imageModal.addEventListener('mousemove', () => { 
                if(imageModal.style.display === "flex") {
                    showShareButtons(); showModalNavButtons(); 
                }
            });
            imageModal.addEventListener('touchstart', (e) => { if (e.touches.length === 1) { touchStartX = e.touches[0].clientX; touchEndX = 0; }}, { passive: true });
            imageModal.addEventListener('touchmove', (e) => { if (e.touches.length === 1) touchEndX = e.touches[0].clientX; }, { passive: true });
            imageModal.addEventListener('touchend', () => {
                if (touchEndX === 0 || Math.abs(touchStartX - touchEndX) < swipeThreshold) return;
                if (touchEndX < touchStartX) navigateModalImage(1); 
                else if (touchEndX > touchStartX) navigateModalImage(-1);
                touchStartX = 0; touchEndX = 0;
            });
        }
        const modalImageElement = document.getElementById('modalImage');
        if (modalImageElement) {
            modalImageElement.addEventListener('click', () => {
                showShareButtons();
                showModalNavButtons();
            });
        }

        if (modalCloseButton) { 
            modalCloseButton.addEventListener('click', hideModal);
        }

        const modalPrevButton = document.getElementById('modalPrevBtn');
        const modalNextButton = document.getElementById('modalNextBtn');

        if (modalPrevButton) {
            modalPrevButton.addEventListener('click', (e) => { e.stopPropagation(); navigateModalImage(-1); });
        }
        if (modalNextButton) {
            modalNextButton.addEventListener('click', (e) => { e.stopPropagation(); navigateModalImage(1); });
        }
        document.addEventListener("keydown", function (e) {
          const modalVisible = imageModal.style.display === "flex"; if (!modalVisible) return;
          if (e.key === "Escape") hideModal();
          else if (e.key === "ArrowRight") navigateModalImage(1);
          else if (e.key === "ArrowLeft") navigateModalImage(-1);
        });

        fetchAndRender();
    }); // é—­åˆ DOMContentLoaded äº‹ä»¶ç›‘å¬å™¨
  </script>

  <!-- å°†æ¨æ’­é€šçŸ¥ç›¸å…³ JS é€»è¾‘æ•´åˆåˆ° pwa-notifications.js -->
  <!-- Service Worker çš„æ³¨å†Œä¹Ÿä¼šåœ¨ pwa-notifications.js ä¸­å®Œæˆ -->
  <script src="pwa-notifications.js"></script>

</body>
<footer class="footer">
        <p>Copyright Â© 2025 è²¡åœ˜æ³•äººå´‡å…ƒæ•™è‚²åŸºé‡‘æœƒ</p>
    </footer>
</html>
