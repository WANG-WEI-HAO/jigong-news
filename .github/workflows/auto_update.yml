name: Update Posts and Deploy to GitHub Pages

on:
  # 1. 當 main 分支有推送時觸發（手動更新或修正後部署）
  push:
    branches:
      - main

  # 2. 定時觸發：每天台灣時間早上 6:50（UTC 時間為 22:50）
  schedule:
    - cron: '50 22 * * *'

# 設定權限：允許 workflow 寫入內容並部署 GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update_posts_and_build:
    runs-on: ubuntu-latest # 使用最新 Ubuntu 環境
    steps:
      # 步驟 1：下載目前 repository 的內容
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步驟 2：設定 Python 環境
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' # 根據你使用的 Python 版本

      # 步驟 3：安裝 mess.py 所需的依賴套件
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      # 步驟 4：執行 mess.py，更新 posts.json 並下載圖片
      - name: Run mess.py to update posts.json
        run: python mess.py

      # ✅ 新增步驟 4.5：先拉取遠端最新版本，避免 push 時發生衝突
      - name: Pull latest changes to avoid push conflict
        run: git pull origin main --rebase

      # 步驟 5：自動 commit 更新的內容（若有變更）
      - name: Commit and push if content changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Automated: Update posts.json and images with new articles"
          file_pattern: posts.json images/*
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "actions@github.com"

      # 步驟 6：上傳網站內容供 GitHub Pages 使用
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.' # 上傳根目錄的所有內容（index.html、posts.json、images 資料夾等）

  # 第二個 job：執行部署到 GitHub Pages
  deploy:
    needs: update_posts_and_build # 需等上一個 job 結束後再執行
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }} # 回傳部署完成後的網址
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
