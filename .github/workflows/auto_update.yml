name: Update Posts and Deploy to GitHub Pages

on:
  # ✅ 當 main 分支有推送時自動執行（手動更新）
  push:
    branches:
      - main

  # ✅ 每天早上 6:50（台灣時間 UTC+8 = UTC 22:50）自動執行
  schedule:
    - cron: '50 22 * * *'

jobs:
  update_and_deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 取出 repo 原始碼
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      # 2️⃣ 設定 Git 使用者資訊（讓 commit 成功）
      - name: Set up Git config
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # 3️⃣ 拉取最新變更（不使用 rebase，避免衝突）
      - name: Pull latest changes (no rebase)
        run: git pull origin main

      # 4️⃣ 執行更新內容的腳本（你可以自行放入產生 sitemap、build 靜態頁面等）
      - name: Run update script
        run: |
          echo "🔄 Running your update scripts here..."
          # python generate_sitemap.py
          # npm run build
          # hugo --minify
          # Rscript update_data.R
          # 可以依你的專案加上實際命令

      # 5️⃣ 自動 commit（如有變更）
      - name: Commit changes
        run: |
          git add .
          git commit -m "🤖 Auto-update content from GitHub Actions" || echo "No changes to commit"

      # 6️⃣ 自動推送至 GitHub（可觸發 GitHub Pages 部署）
      - name: Push changes to GitHub
        uses: ad-m/github-push-action@v0.6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
